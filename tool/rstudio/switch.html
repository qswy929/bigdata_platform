<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>跳转</title>
    <link rel="icon" href="../../favicon.ico" type="image/x-icon" />  
    <link rel="shortcut icon" href="../../favicon.ico" type="image/x-icon" />  
    <link rel="apple-touch-icon" href="../../apple-touch-icon.png">
    <!-- Place favicon.ico in the root directory -->   
    <link rel="stylesheet" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="../../css/main.css">
    <style type="text/css">
      body{
        padding-top: 0px !important;
      }
    </style>
    
  </head>
  <body>
    <!--[if lt IE 10]>
      <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <div id="form_signin">
      <h4>跳转中……</h4>
    </div>
   
    <script src="../../js/jquery-3.1.1.min.js"></script>
    <script src="../../js/jquery.cookie.js"></script>
    <script src="../../js/encrypt.min.js" type="text/javascript"></script>
    <script src="../../js/bootstrap.min.js" type="text/javascript"></script>
    <!-- vue.js -->
    <script src="https://cdn.bootcss.com/vue/2.2.4/vue.min.js"></script>
    <script src="https://cdn.bootcss.com/vue-resource/1.2.1/vue-resource.min.js"></script>


    <!-- 这里加入js代码 -->
    <script type="text/javascript">
      new Vue ({
        el: '#form_signin',
        data : {
          apiUrl: '../../api/v1/user/autosignin',
          keyUrl: "auth-public-key",
          doUrl: "auth-do-sign-in",
          persist: "0",
          appUri:'',
          clientPath:"/tool/rstudio/auth-sign-in"
        },
        methods: {
          getUrlParams: function(){
            var vars = [], hash;
            var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
            for(var i = 0; i < hashes.length; i++)
            {
              hash = hashes[i].split('=');
              vars.push(hash[0]);
              vars[hash[0]] = hash[1];
            }
            return vars;
          },
          getUrlParam: function(name){
            return this.getUrlParams()[name];
          },
          onLoad: function() {
            if(typeof($.cookie('user-id'))=="undefined" || $.cookie('user-id') == null)  //cookie为空
            {
              this.$http.post(this.apiUrl).then(function(response){
              // 响应成功回调
                if(response.body!="Error") 
                {
                  var username = response.body;
                  //在RStudio中登录
                  this.$http.get(this.keyUrl).then(function(response){
                    // 响应成功回调
                    if(response.body!="")
                    {
                      var payload = username + "\n" + username;
                      var chunks = response.body.split(':', 2);
                      //console.log(chunks);
                      var exp = chunks[0];
                      var mod = chunks[1];
                      var encrypted = encrypt(payload, exp, mod);

                      this.$http.post(this.doUrl,{persist:this.persist,v:encrypted,clientPath:this.clientPath,appUri:this.appUri}).then(function(response){
                        // 响应成功回调
                          window.location.href="../r.html?db="+this.getUrlParam('db');

                      },function(response){
                        // 响应错误回调
                        alert("自动登录失败！");
                        window.location.href="../../index.html";
                      }); 
                    }
                  },function(response){
                    // 响应错误回调
                    alert("抱歉，RStudio服务器无响应！");
                    window.location.href="../../index.html";
                  }); 
                  
                } 
                else
                {
                  alert("自动登录失败！");
                  window.location.href="../../index.html";
                }
      
              }, function(response){
                 // 响应失败回调
                  alert("自动登录失败！");
                  window.location.href="../../index.html";
              });
            }
            else
            {
              //cookie尚有效
              window.location.href="../r.html?db="+this.getUrlParam('db');
            }
          }
        },
        mounted: function() {
          this.onLoad();
        }
      });
      Vue.http.options.emulateJSON = true;
    </script>
  </body>
</html>
